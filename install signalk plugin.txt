#!/bin/bash
# SignalK Heartbeat Plugin Installer
# Sends a heartbeat every 10 seconds via WebSocket for connection monitoring
# It makes it easier for a remote display to tell if the data from the SignalK server is updating
# The data from the Raymarine Tillerpilot is considered stale if the magnetic heading is not updated within 30 seconds
# For best fault detection, these are handled as two separate cases
# Designed and tested on a SignalK server installed on a Raspberry Pi 5

echo "Installing SignalK Heartbeat Plugin..."

# Create plugin directory
PLUGIN_DIR="$HOME/.signalk/node_modules/signalk-heartbeat"
mkdir -p "$PLUGIN_DIR"
cd "$PLUGIN_DIR"

# Create package.json
cat > package.json << 'EOF'
{
  "name": "signalk-heartbeat",
  "version": "1.0.0",
  "description": "Heartbeat for connection monitoring",
  "main": "index.js",
  "keywords": ["signalk-node-server-plugin"]
}
EOF

# Create index.js
cat > index.js << 'EOF'
module.exports = function(app) {
  let timer = null;
  let counter = 0;
  
  const plugin = {
    id: 'heartbeat',
    name: 'Heartbeat',
    description: 'Sends heartbeat every 10 seconds via WebSocket',
    
    start: function(options) {
      app.setPluginStatus('Started');
      
      timer = setInterval(() => {
        counter++;
        const delta = {
          updates: [{
            source: { label: 'heartbeat' },
            timestamp: new Date().toISOString(),
            values: [{
              path: 'environment.heartbeat',
              value: {
                counter: counter,
                timestamp: new Date().toISOString()
              }
            }]
          }]
        };
        
        app.handleMessage('heartbeat', delta);
      }, 5000);
    },
    
    stop: function() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
      app.setPluginStatus('Stopped');
    }
  };
  
  return plugin;
};
EOF

echo "Plugin files created successfully in $PLUGIN_DIR"
echo ""
echo "Restarting SignalK server..."
sudo systemctl restart signalk

echo ""
echo "Installation complete!"
echo ""
echo "Next steps:"
echo "1. Open SignalK admin interface (usually http://localhost:3000)"
echo "2. Go to Server â†’ Plugin Config"
echo "3. Find 'Heartbeat' and toggle it to Active"
echo "4. The plugin will send updates to 'environment.heartbeat' every 30 seconds"
echo ""

echo "Monitor the path 'environment.heartbeat' in your WebSocket stream."


